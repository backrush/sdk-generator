const fs = require("fs");
const tar = require("tar");
const { Command } = require("commander");
const inquirer = require("inquirer");
const { messagingListTopics } = require("./messaging");
const { teamsList } = require("./teams");
const { projectsGet } = require("./projects");
const { functionsList, functionsDownloadDeployment } = require("./functions");
const { databasesGet, databasesListCollections, databasesList } = require("./databases");
const { storageListBuckets } = require("./storage");
const { localConfig } = require("../config");
const { paginate } = require("../paginate");
const { questionsPullCollection, questionsPullFunctions, questionsPullResources } = require("../questions");
const { success, log, actionRunner, commandDescriptions } = require("../parser");

const pullResources = async ({ all, yes } = {}) => {
    const actions = {
        project: pullProject,
        functions: pullFunctions,
        collections: pullCollection,
        buckets: pullBucket,
        teams: pullTeam,
        messages: pullMessagingTopic
    }

    if (all) {
        for (let action of Object.values(actions)) {
            await action({ all: true, yes });
        }
    } else {
        const answers = await inquirer.prompt(questionsPullResources[0]);
        answers.resources.forEach((resource) => {
            const action = actions[resource];
            if (action !== undefined) {
                action({ all: true, yes });
            }
        })
    }
};

const pullProject = async () => {
    try {
        let response = await projectsGet({
            parseOutput: false,
            projectId: localConfig.getProject().projectId

        })

        localConfig.setProject(response.$id, response.name);
        localConfig.setProjectSettings(response);

        success();
    } catch (e) {
        throw e;
    }
}

const pullFunctions = async ({ all } = {}) => {
    const localFunctions = localConfig.getFunctions();

    const functions = all
        ? (await paginate(functionsList, { parseOutput: false }, 100, 'functions')).functions
        : (await inquirer.prompt(questionsPullFunctions)).functions;

    log(`Pulling ${functions.length} functions`);

    for (let func of functions) {
        const functionExistLocally = localFunctions.find((localFunc) => localFunc['$id'] === func['$id']) !== undefined;

        if (functionExistLocally) {
            localConfig.updateFunction(func['$id'], func);
        } else {
            func['path'] = `functions/${func['$id']}`;
            localConfig.addFunction(func);
            localFunctions.push(func);
        }

        const localFunction = localFunctions.find((localFunc) => localFunc['$id'] === func['$id']);

        if (localFunction['deployment'] === '') {
            continue
        }

        const compressedFileName = `${func['$id']}-${+new Date()}.tar.gz`

        await functionsDownloadDeployment({
            functionId: func['$id'],
            deploymentId: func['deployment'],
            destination: compressedFileName,
            overrideForCli: true,
            parseOutput: false
        })

        if (!fs.existsSync(localFunction['path'])) {
            fs.mkdirSync(localFunction['path'], { recursive: true });
        }

        tar.extract({
            sync: true,
            cwd: localFunction['path'],
            file: compressedFileName,
            strict: false,
        });

        fs.rmSync(compressedFileName);
        success(`Pulled ${func['name']} code and settings`)
    }
}

const pullCollection = async ({ all, databaseId } = {}) => {
    const databaseIds = [];

    if (databaseId) {
        databaseIds.push(databaseId);
    } else if (all) {
        let allDatabases = await databasesList({
            parseOutput: false
        })

        databaseIds.push(...allDatabases.databases.map((d) => d.$id));
    }

    if (databaseIds.length <= 0) {
        let answers = await inquirer.prompt(questionsPullCollection)
        databaseIds.push(...answers.databases);
    }

    for (const databaseId of databaseIds) {
        const database = await databasesGet({
            databaseId,
            parseOutput: false
        });

        localConfig.addDatabase(database);

        const { collections, total } = await paginate(databasesListCollections, {
            databaseId,
            parseOutput: false
        }, 100, 'collections');

        log(`Found ${total} collections`);

        collections.forEach(async collection => {
            log(`Fetching ${collection.name} ...`);
            localConfig.addCollection({
                ...collection,
                '$createdAt': undefined,
                '$updatedAt': undefined,
            });
        });
    }

    success();
}

const pullBucket = async () => {
    const { buckets } = await paginate(storageListBuckets, { parseOutput: false }, 100, 'buckets');

    log(`Found ${buckets.length} buckets`);

    buckets.forEach(async bucket => {
        log(`Fetching ${bucket.name} ...`);
        localConfig.addBucket(bucket);
    });

    success();
}

const pullTeam = async () => {
    const { teams } = await paginate(teamsList, { parseOutput: false }, 100, 'teams');

    log(`Found ${teams.length} teams`);

    teams.forEach(async team => {
        log(`Fetching ${team.name} ...`);
        const { total, $updatedAt, $createdAt, prefs, ...rest } = team;
        localConfig.addTeam(rest);
    });

    success();
}

const pullMessagingTopic = async () => {
    const { topics } = await paginate(messagingListTopics, { parseOutput: false }, 100, 'topics');

    log(`Found ${topics.length} topics`);

    topics.forEach(async topic => {
        log(`Pulling ${topic.name} ...`);
        localConfig.addMessagingTopic(topic);
    });

    success();
}

const pull = new Command("pull")
    .description(commandDescriptions['pull'])
    .configureHelp({
        helpWidth: process.stdout.columns || 80
    });

pull
    .command("all")
    .description("Push all resource.")
    .option(`--all`, `Flag to pull all functions`)
    .option(`--yes`, `Flag to confirm all warnings`)
    .action(actionRunner(pullResources));


pull
    .command("project")
    .description("Pulling your {{ spec.title|caseUcfirst }} project name, services and auth settings")
    .action(actionRunner(pullProject));

pull
    .command("functions")
    .description(`Pulling your {{ spec.title|caseUcfirst }} functions`)
    .option(`--all`, `Flag to pull all functions`)
    .action(actionRunner(pullFunctions));

pull
    .command("collections")
    .description("Pulling your {{ spec.title|caseUcfirst }} collections")
    .option(`--databaseId <databaseId>`, `Database ID`)
    .option(`--all`, `Flag to pull all databases`)
    .action(actionRunner(pullCollection))

pull
    .command("buckets")
    .description("Pulling your {{ spec.title|caseUcfirst }} buckets")
    .action(actionRunner(pullBucket))

pull
    .command("teams")
    .description("Pulling your {{ spec.title|caseUcfirst }} teams")
    .action(actionRunner(pullTeam))

pull
    .command("topics")
    .description("Initialise your Appwrite messaging topics")
    .action(actionRunner(pullMessagingTopic))

module.exports = {
    pull,
};
