const fetch =
  typeof globalThis.EdgeRuntime !== "string" &&
  typeof globalThis.fetch === "undefined"
    ? require("undici").fetch
    : globalThis.fetch;

const FormData =
  typeof globalThis.EdgeRuntime !== "string" &&
  typeof globalThis.EdgeRuntime !== "string" &&
  typeof globalThis.FormData === "undefined"
    ? require("undici").FormData
    : globalThis.FormData;

const File =
  typeof globalThis.EdgeRuntime !== "string" &&
  typeof globalThis.File === "undefined"
    ? require("undici").File
    : globalThis.File;

/** @type {(selfSigned: boolean) => import('undici').Agent|undefined} */
let dispatcher = (_selfSigned) => undefined;

if (typeof globalThis.EdgeRuntime !== "string") {
  const Agent = require("undici").Agent;
  dispatcher = (selfSigned) =>
    new Agent({
      connect: {
        rejectUnauthorized: !selfSigned,
      },
    });
}

function buildUserAgent() {
  const base = `{{spec.title | caseUcfirst}}{{language.name | caseUcfirst}}SDK/{{ sdk.version }}`;

  if (typeof globalThis.EdgeRuntime !== "string") {
    try {
      const os = require("os");
      return `${base} (${os.type()}; ${os.version()}; ${os.arch()})`;
    } catch {
      return base;
    }
  }

  return `${base} (${globalThis.EdgeRuntime}; Edge)`;
}

module.exports = {
  fetch,
  FormData,
  File,
  dispatcher,
  USER_AGENT: buildUserAgent(),
};
