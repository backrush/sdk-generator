module Appwrite
  class Payload
    attr_reader :filename
    attr_reader :size

    def initialize(data, path, filename)
      @path = path
      @data = data

      @filename = filename
      @size = if @data then
        @data.bytesize
      else
        File.size(@path)
      end
    end

    # @param [Integer] offset
    # @param [Integer, nil] length
    # @return [String]
    def to_binary(offset: 0, length: nil)
      length = length || @size
      if @data then
        @data.byteslice(offset, length)
      else
        IO.read(@path, length, offset)
      end
    end

    # @param [String] encoding
    # @return [String]
    def to_s(encoding: 'UTF-8')
      to_binary().force_encoding(encoding)
    end

    alias to_string to_s

    # @param [String] encoding
    # @return [Hash]
    def to_json(encoding: 'UTF-8')
      JSON.parse(to_s())
    end

    # @param [String] path 
    # @return [void]
    def to_file(path)
      File.open(path, 'wb') { |f| f.write(to_binary()) }
    end

    # @param [String] bytes
    # @param [String, nil] filename
    # @return [Payload]
    def self.from_binary(bytes, filename: nil)
      new(bytes, nil, filename)
    end

    # @param [String] string
    # @param [String, nil] filename
    # @return [Payload]
    def self.from_string(string, encoding: 'UTF-8', filename: nil)
      bytes = string.encode(encoding)
      new(bytes, nil, filename)
    end

    # @param [Hash, Array] object
    # @param [String] encoding
    # @param [String, nil] filename
    # @return [Payload]
    def self.from_json(json, encoding: 'UTF-8', filename: nil)
      json = JSON.generate(object) if object.is_a?(Hash) || object.is_a?(Array)
      self.from_string(json, encoding: encoding, filename: filename)
    end


    # @param [String] path
    # @param [String, nil] filename
    # @return [Payload]
    def self.from_file(path, filename: nil)
      filename = if filename.nil? then
        File.basename(path)
      else
        filename
      end
      new(nil, path, filename)
    end
  end
end