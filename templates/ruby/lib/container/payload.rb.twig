module Appwrite
  class Payload
    attr_reader :data
    attr_reader :filename

    def initialize(data: nil, path: nil, filename: nil)
      @path = path
      @data = data
      @filename = filename

      @size = if @data then
        @data.bytesize
      else
        File.size(@path)
      end
    end

    def read(offset: 0, length: nil)
      if @data then
        @data.byteslice(offset, length || @data.bytesize)
      else
        IO.read(@path, length || File.size(@path), offset)
      end
    end

    # @param [String] path
    # @param [String, nil] filename
    # @return [Payload]
    def self.from_path(path, filename: nil)
        filename = if filename.nil? then
          File.basename(path)
        else
          filename
        end
      new(FilePayload.new(path), filename: filename)
    end

    # @param [String] b
    # @param [String, nil] filename
    def self.from_binary(b, filename: nil)
      new(b, nil, filename)
    end

    # @param [Hash, Array] object
    # @param [String, nil] filename
    def self.from_json(object, filename: nil)
      json = JSON.generate(object) if object.is_a?(Hash) || object.is_a?(Array)
      new(json, nil, filename)
    end

    # @param [String] string
    # @param [String, nil] filename
    def self.from_string(string, filename: nil)
      new(string, nil, filename)
    end

    # @return [String]
    def to_s
      @data.read()
    end

    alias :to_string :to_s
    alias :to_binary :to_s

    # @return [Hash]
    def to_json
      JSON.parse(@data.read())
    end

    private_class_method :new
  end
end
