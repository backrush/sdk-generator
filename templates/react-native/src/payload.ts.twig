interface ReactNativeFileObject {
  uri: string;
  type?: string;
  name?: string;
}

export class Payload {
  private data: Buffer;
  public filename?: string;
  public size: number;

  constructor(data: Buffer, filename?: string) {
    this.data = data;
    this.filename = filename;
    this.size = data.byteLength;
  }

  public toBinary(offset: number = 0, length?: number): Buffer {
    if (offset === 0 && length === undefined) {
      return this.data;
    } else if (length === undefined) {
      return this.data.subarray(offset);
    } else {
      return this.data.subarray(offset, offset + length);
    }
  }

  public toFileObject(type: string): ReactNativeFileObject {
    return {
      uri: `data:${type};base64,${this.data.toString("base64")}`,
      type: type,
      name: this.filename,
    };
  }

  public toJson<T = unknown>(): Promise<T> {
    return JSON.parse(this.toString());
  }

  public toString(): string {
    return this.data.toString("utf-8");
  }

  public static fromBinary(bytes: Buffer, name?: string): Payload {
    return new Payload(bytes, name);
  }

  public static fromJson(object: any, name?: string): Payload {
    const data = Buffer.from(JSON.stringify(object), "utf-8");
    return new Payload(data, name);
  }

  public static fromString(text: string, name?: string): Payload {
    const data = Buffer.from(text, "utf-8");
    return new Payload(data, name);
  }

  public static async fromFileObject(file: ReactNativeFileObject): Promise<Payload> {
    const response = await fetch(file.uri);
    const data = Buffer.from(await response.arrayBuffer());
    return new Payload(data, file.name);
  }
}