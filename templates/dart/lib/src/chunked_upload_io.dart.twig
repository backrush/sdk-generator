import 'client.dart';
import 'dart:io' as io;
import 'enums.dart';
import 'package:http/http.dart' as http;
import 'response.dart';
import 'dart:math';
import 'input_file.dart';
import 'exception.dart';

Future<Response> chunkedUpload({
  required Client client,
  required String path,
  required Map<String, dynamic> params,
  required String paramName,
  required Map<String, String> headers,
  Function(double)? onProgress,
}) async {
  InputFile file = params[paramName];
  if (file.path == null) {
    throw AppwriteException("File path must be provided for dart:io");
  }
  io.File iofile = io.File(file.path!);
  final size = await iofile.length();

  late Response res;
  if (size <= Client.CHUNK_SIZE) {
    params[paramName] = await http.MultipartFile.fromPath(paramName, file.path!, filename: file.fileName);
    return client.call(
      HttpMethod.post,
      path: path,
      params: params,
      headers: headers,
    );
  }
  // read chunk and upload each chunk
  var offset = 0;
  final raf = iofile.openSync(mode: io.FileMode.read);

  while (offset < size) {
    final chunk = raf.readSync(Client.CHUNK_SIZE);
    params[paramName] =
        http.MultipartFile.fromBytes(paramName, chunk, filename: iofile.path);
    headers['content-range'] =
        'bytes $offset-${min<int>(((offset + Client.CHUNK_SIZE) - 1), size)}/$size';
    res = await client.call(HttpMethod.post,
        path: path, headers: headers, params: params);
    offset += Client.CHUNK_SIZE;
    if(offset < size) {
      headers['x-appwrite-id'] = res.data['\$id'];
    }
    onProgress?.call(min(offset,size)/size * 100);
  }
  return res;
}
