//
// Client.swift
//
// Created by Armino <devel@boioiong.com>
// GitHub: https://github.com/armino-dev/sdk-generator
//

import Foundation

open class Client {

    // MARK: Properties

    open var selfSigned = false

    open var endpoint = "{{spec.endpoint}}"

    open var headers: [String: String] = [
      "content-type": "",
      "x-sdk-version": "{{spec.title | caseDash}}:{{ language.name | caseLower }}:{{ sdk.version }}"
    ]


    // MARK: Methods

    // default constructor
    public init() {

    }

    {% for header in spec.global.headers %}
    ///
    /// Set {{header.key | caseUcfirst}}
    ///
    {% if header.description %}
    /// {{header.description}}
    ///
    {% endif %}
    /// @param String value
    ///
    /// @return Client
    ///
    open func set{{header.key | caseUcfirst}}(value: String) -> Client {

        self.addHeader(key: "{{header.name}}", value: value)
        return self
    }

    {% endfor %}

    ///
    /// @param Bool status
    /// @return Client
    ///
    open func setSelfSigned(status: Bool = true) -> Client {

        self.selfSigned = status
        return self
    }

    ///
    /// @param String endpoint
    /// @return Client
    ///
    open func setEndpoint(endpoint: String) -> Client {

        self.endpoint = endpoint
        return self
    }

    ///
    /// @param String key
    /// @param String value
    ///
    open func addHeader(key: String, value: String) -> Client {

        self.headers[key.lowercased()] = value.lowercased()

        return self
    }

    open func flatten(params: Array<Any>) -> String {
        return ""
    }

    open func httpBuildQuery(params: Array<Any>) -> String {
        return ""
    }

    ///
    /// Make an API call
    ///
    /// @param String method
    /// @param String path
    /// @param Array params
    /// @param Array headers
    /// @return Array|String
    /// @throws Exception
    ///
    func call(method:String, path:String = "", headers:[String: String] = [:], params:[String: Any] = [:]) -> Any {

        //let headers = self.headers + headers
        self.headers.merge(headers){(current, _) in current}
        let targetURL = URL(string: self.endpoint + path + (( method == HTTPMethod.get.rawValue && !params.isEmpty ) ? "?" + httpBuildQuery(params: params) : ""))

        var query = ""

        var responseHeaders    = Array<Any>()
        var responseStatus     = -1
        var responseType       = ""
        var responseBody       = ""

        switch (self.headers["content-type"]) {
            case "application/json":
              do {
                let json = try JSONSerialization.data(withJSONObject:params, options: [])
                query = String( data: json, encoding: String.Encoding.utf8)!
              } catch let error as NSError {
                print("Failed to parse json: \(error.localizedDescription)");
              }
              break
            case "multipart/form-data":
              query = self.flatten(params: params)
              break
            default:
              query = httpBuildQuery(params: params)
              break
        }

        // more work here

        return responseBody;
    }

}

extension Client {

    public enum HTTPStatus: Int {
      case ok = 200

      case badRequest = 400
      case notAuthorized = 401
      case paymentRequired = 402
      case forbidden = 403
      case notFound = 404

      case internalServerError = 500
    }

    public enum HTTPMethod: String {
      case get

      case post
      case put
      case patch

      case delete

      case head
      case options
      case connect
      case trace
    }


}
