import AsyncHTTPClient
import Foundation
import NIO
import NIOHTTP1

extension HTTPClient.Request {
    public mutating func addDomainCookies() {
        headers.addDomainCookies(for: url.host!)
    }
}

extension HTTPHeaders {
    public mutating func addDomainCookies(for domain: String) {
        let cookieJson = UserDefaults.standard.string(forKey: "\(domain)-cookies")
        let cookies: [HTTPClient.Cookie?]? = try? cookieJson?.fromJson(to: [HTTPClient.Cookie].self)
            ?? [(try? cookieJson?.fromJson(to: HTTPClient.Cookie.self))]

        var cookiesValue = ""
        for cookie in cookies ?? [] {
            if let cookie = cookie {
                cookiesValue += "\(cookie.name)=\(cookie.value);"
            }
        }
        add(name: "Cookie", value: cookiesValue)
}
}